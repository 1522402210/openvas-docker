machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
  override:
    - mkdir -p ~/docker
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi
    - curl --fail -L -O https://github.com/phusion/baseimage-docker/archive/master.tar.gz && tar xzf master.tar.gz && sudo ./baseimage-docker-master/install-tools.sh

test:
  override:
    - docker build -t mikesplain/openvas:base openvas_base:
        timeout: 900
    - docker build -t mikesplain/openvas:full openvas_full:
        timeout: 1200
    - docker build -t mikesplain/openvas:test test:
        timeout: 900
    - docker run -d -p 443:443 -p 9390:9390 -p 9391:9391 mikesplain/openvas:test:
        timeout: 900
    - sleep 3m:
        timeout: 240
    - docker-ssh $(docker ps -q) /openvas-check-setup:
        timeout: 900

  post:
    - mkdir -p ~/docker; docker save mikesplain/openvas > ~/docker/image.tar
