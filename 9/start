#!/bin/bash

DATAVOL=/var/lib/openvas/mgr/
OV_PASSWORD=${OV_PASSWORD:-admin}

redis-server /etc/redis/redis.conf

echo "Testing redis status..."
X="$(redis-cli ping)"
while  [ "${X}" != "PONG" ]; do
        echo "redis not yet ready"
        sleep 1
        X="$(redis-cli ping)"
done
echo "Redis ready."

echo "Checking for empty volume"
[ -e "$DATAVOL/tasks.db" ] || SETUPUSER=true

echo "Restarting services"
service openvas-scanner restart
service openvas-manager restart
service openvas-gsa restart


echo "Reloading NVTs"
openvasmd --rebuild --progress

if [ -n "$SETUPUSER" ]; then
  echo "Setting up user"
  /usr/sbin/openvasmd openvasmd --create-user=admin
  /usr/sbin/openvasmd --user=admin --new-password=$OV_PASSWORD
fi

echo "Checking setup"
./openvas-check-setup --v9

if [ -f /sasl_passwd_template ]; then
  echo "Configuring postfix"

  set -o nounset
  set -o errexit
  set -o pipefail

  envsubst < "/sasl_passwd_template" > "/etc/postfix/sasl_passwd"
  envsubst < "/main.cf_template" > "/etc/postfix/main.cf"

  /usr/sbin/postmap /etc/postfix/sasl_passwd

  service postfix restart
fi

if [ -z "$BUILD" ]; then
  echo "Tailing logs"
  tail -F /var/log/openvas/*
fi
